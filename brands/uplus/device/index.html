<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MCCNETWORLD · 미디어로그 단말</title>

<link rel="icon" type="image/png" sizes="16x16"  href="/mccnetworld/favicon-16x16.png?v=2">
<link rel="icon" type="image/png" sizes="32x32"  href="/mccnetworld/favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="192x192" href="/mccnetworld/android-chrome-192x192.png?v=2">
<link rel="icon" type="image/png" sizes="512x512" href="/mccnetworld/android-chrome-512x512.png?v=2">
<link rel="apple-touch-icon" href="/mccnetworld/apple-touch-icon.png?v=2">
<link rel="shortcut icon" href="/mccnetworld/favicon.ico?v=2">
<meta name="theme-color" content="#0c1117"/>

<style>
  :root{
    --bg:#0c1117;--fg:#eaf1ff;--card:#121a24;--line:#243347;
    --pink:#e6007e;--vio:#6a35ff;--danger:#ff3b3b;
    --zoom:1;
    --stage-w:210mm;
    --stage-h:297mm;
    --phc:#c05;--phbg:#ffe08a66;
  }

  *{box-sizing:border-box;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,"Noto Sans KR",sans-serif}
  .wrap{display:grid;grid-template-columns:1.6fr 1fr;gap:12px;min-height:100vh;padding:12px}
  html.fill .wrap{grid-template-columns:1fr}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:visible}
  .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .hd strong{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid #ffffff1f;background:linear-gradient(90deg,var(--pink),var(--vio));color:#fff;cursor:pointer}
  .btn--ghost{background:#182234;border-color:#2b3a54;color:#d6e4ff}
  .stack{padding:12px;overflow:auto}

  /* 화면 캔버스 */
  .paper{position:relative;width:min(1480px,100%);margin:auto;border:1px solid #223049;border-radius:10px;background:#0f1624;height:calc((var(--stage-h)) * var(--zoom));overflow:hidden;}
  .stage{width:var(--stage-w);height:var(--stage-h);transform-origin:top left;transform:scale(var(--zoom));position:relative;}
  .stage img{position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none}
  .overlay{position:absolute;inset:0}

  /* 필드 */
  .field{position:absolute;transform:none;cursor:move;z-index:2;--fs:18px;}
  .field.checkbox{transform:translate(-50%,-50%)}
  .label{position:absolute;top:-16px;left:0;font-size:12px;font-weight:800;text-shadow:0 1px 2px #0009}
  .field input,.field textarea,.field select{
    width:100%;background:transparent;border:none;color:var(--fgc,#fff);
    height:var(--ih,28px);outline:none;padding:0 6px;font:700 var(--fs)/1.2 system-ui
  }
  .field:focus-within{
    outline: 3px solid #e724ee83;
    outline-offset: 0px;
    border-radius: 0px;
    background: rgba(37,99,235,.03);
  }

  /* ✅ 길면 자동 축소용(한 줄 고정) */
  .field input.fit-one-line,
  .field textarea.fit-one-line{
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: clip !important;
  }

  /* 세로 가운데(텍스트 한 줄용) */
  .field input[type="text"],
  .field select{
    line-height: var(--ih, 28px);
    padding-top: 0;
    padding-bottom: 0;
  }

  /* 리사이즈 손잡이 */
  .field .resize-handle{
    position:absolute;
    right:-6px;
    bottom:-6px;
    width:12px;
    height:12px;
    border-radius:3px;
    cursor:nwse-resize;
    opacity:0;
    border:1px solid transparent;
    background:transparent;
    box-shadow:none;
  }
  .field:hover .resize-handle,
  .field.sel .resize-handle{
    opacity:1;
    border-color:#60a5fa;
    background:#1d4ed8;
    box-shadow:0 0 0 1px #0b1120;
  }
  html.fill .field .resize-handle{display:none !important;}

  /* 서류 영역(왼쪽 캔버스) 드롭다운 화살표 숨기기 */
  .paper .field select{
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: none !important;
    padding-right: 8px;
  }

  /* 필드(중복 선언 정리) */
  .field input,
  .field select{
    width:100%;
    background:transparent;
    border:none;
    color:var(--fgc,#fff);
    height:var(--ih,28px);
    outline:none;
    padding:0 6px;
    font:700 var(--fs)/1.2 system-ui;
    text-align:var(--ta,left);
    line-height:var(--ih,28px);
  }

  /* textarea는 autosize가 있으니 line-height만 유지하고 height는 JS가 제어 */
  .field textarea{
    width:100%;
    background:transparent;
    border:none;
    color:var(--fgc,#fff);
    outline:none;
    padding:0 6px;
    font:700 var(--fs)/1.2 system-ui;
    text-align:var(--ta,left);

    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:anywhere;
    overflow:hidden;
    resize:none !important;
    min-height:5px;
    max-height:none !important;
  }

  .field textarea::-webkit-scrollbar{display:none}

  /* 입력 잠금(시각적 안내만) */
  .field [data-locked="1"]{caret-color:transparent}
  .field [data-locked="1"]::placeholder{color:var(--phc);font-weight:900;background:var(--phbg);padding:0 .25em;border-radius:6px;}

  /* 체크/라디오 */
  .field.checkbox input,.field.radio input[type="checkbox"]{
    appearance:none;-webkit-appearance:none;background:transparent;
    border:var(--tick-bdw,1.6px) solid var(--tick-bdc,#000);
    position:relative;vertical-align:middle;display:inline-block;box-sizing:border-box;
  }

  /* ===== radio 표시 스타일 3종 (dot / solid / tick) ===== */
  .field.radio.rd-dot input[type="checkbox"]:checked::after{
    content:"";
    position:absolute;
    inset:3px;
    border-radius:999px;
    background:#000;
  }
  .field.radio.rd-solid input[type="checkbox"]:checked::after{
    content:"";
    position:absolute;
    inset:2px;
    border-radius:999px;
    background:#000;
  }
  .field.radio.rd-tick input[type="checkbox"]:checked::after{
    content:"";
    position:absolute;
    left:5px;
    top:2px;
    width:calc(var(--rsize,18px) - 10px);
    height:calc(var(--rsize,18px) - 10px);
    border-right:2px solid #000;
    border-bottom:2px solid #000;
    transform:rotate(45deg);
    border-radius:0;
  }

  .field.checkbox input{width:var(--cksize,18px);height:var(--cksize,18px);border-radius:2px;}
  .field.checkbox.ck-tick input:checked::after,
  .field.checkbox:not(.ck-solid):not(.ck-dot) input:checked::after{
    content:"";
    position:absolute;
    left:3px;
    top:0px;
    width:calc(var(--cksize,18px) - 6px);
    height:calc(var(--cksize,18px) - 6px);
    border-right:2px solid #000;
    border-bottom:2px solid #000;
    transform:rotate(45deg) translateY(-2px);
  }
  .field.checkbox.ck-solid input:checked::after{
    content:"";
    position:absolute;
    inset:2px;
    background:#000;
    border:none;
    transform:none;
  }
  .field.checkbox.ck-dot input:checked::after{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width:calc(var(--cksize,18px) * 0.45);
    height:calc(var(--cksize,18px) * 0.45);
    background:#000;
    border-radius:999px;
    transform:translate(-50%,-50%);
    border:none;
  }

  .field.checkbox .label{top:0;left:24px}

  /* ===== radio 개선 ===== */
  .field.radio{ white-space: normal; }
  .field.radio > div{
    display:flex;
    flex-wrap:wrap;
    gap: var(--rgap,0px);
    align-items:center;
    max-width:100%;
  }

  .field.radio .radio-item{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:0;
    border-radius:8px;
    border: var(--rbw,1px) solid var(--rbc, rgba(0,0,0,.25));
    background: var(--rbg, transparent);
    flex:0 1 auto;
    max-width:100%;
  }
  .field.radio .radio-item span{
    display:inline;
    font-weight:700;
    color:#000;
    white-space:normal;
    word-break:keep-all;
  }
  .field.radio.noText .radio-item span{display:none !important;}

  .sel{outline:3px solid #00d2ff66;border-radius:8px}

  /* 우측 기본도구 */
  .group{border:2px solid #2b3a54;border-radius:12px;padding:10px;margin:10px 0 14px;background:#0f1624}
  .group h4{margin:0 0 8px;font-size:12px;color:#9fb0cc;font-weight:800;letter-spacing:.4px}
  .row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin-bottom:8px}
  .row input,.row select,.row textarea{width:100%;background:#0f1624;border:1px solid #2b3a54;border-radius:10px;color:#dfe9ff;outline:none;padding:8px 10px;font-weight:700}
  .hint{color:#9fb0cc;font-size:12px}
  .stack .paper{margin-bottom:56px}
  .stack{padding-bottom:140px}
  .pager{display:flex;align-items:center;gap:8px;justify-content:center;margin:6px 0 18px;flex-wrap:wrap}
  #pageInfo{min-width:84px;text-align:center;font-weight:800}

  .toast{position:fixed;left:0;right:0;bottom:16px;display:none;justify-content:center;z-index:9999}
  .toast__card{background:#172131;border:1px solid #2b3a54;border-radius:10px;padding:10px 12px;color:#fff;max-width:680px;width:calc(100% - 32px)}
  .invalid{outline:3px solid var(--danger)!important;background:rgba(255,59,59,.2);border-radius:8px}
  html.fill .builder{display:none}

  /* 인쇄 공통 */
  @page{size:A4 portrait;margin:0}
  #printAll{display:none}
  .print-value{display:none;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;padding:6px 6px 3px;font:600 var(--fs)/1.2 system-ui}

  /* ✅ PRINT: radio (원형 유지) */
  .field.radio input[type="checkbox"]{
    width:var(--rsize,18px) !important;
    height:var(--rsize,18px) !important;
    border-radius:999px !important;
  }

  @media print{
    body{background:#fff}
    .wrap,.builder,.pager,.hint,.hd,#affPopup{display:none !important}
    #printAll{display:block}
    .pageWrap{width:210mm;height:297mm;position:relative;overflow:visible;padding:0;box-sizing:border-box;page-break-after:always;}
    .pageWrap:last-child{page-break-after:auto}
    #printAll .stage{transform:scale(1)}
    #printAll .paper{border:none;height:auto}
    #printAll .stage img{width:100%;height:100%;object-fit:fill}
    #printAll .overlay{position:absolute;inset:0;overflow:visible !important}
    #printAll,#printAll *{font-family:system-ui,"Noto Sans KR",sans-serif !important;letter-spacing:0 !important}
    #printAll .field input,#printAll .field textarea,#printAll .field select{color:#000 !important;background:transparent !important;border-bottom:none !important}
    #printAll .label{color:#000 !important;text-shadow:none !important}
    #printAll .field.radio .radio-item span{display:inline !important;color:#000 !important}
    #printAll .field select{display:none !important}
    #printAll .field .print-value{display:block !important;color:#000 !important}

    #printAll textarea{
      height:auto !important;
      resize:none !important;
      max-height:none !important;
    }

    .field.checkbox input,.field.radio input[type="checkbox"]{
      appearance:none !important;
      -webkit-appearance:none !important;
      background:transparent !important;
      border:var(--tick-bdw,1.6px) solid var(--tick-bdc,#000) !important;
      position:relative !important;
      vertical-align:middle;
    }
    .field.checkbox input{
      width:var(--cksize,18px) !important;
      height:var(--cksize,18px) !important;
      border-radius:2px !important
    }

    .field.radio.rd-dot input[type="checkbox"]:checked::after{
      content:"";
      position:absolute;
      inset:3px;
      border-radius:999px;
      background:#000;
    }
    .field.radio.rd-solid input[type="checkbox"]:checked::after{
      content:"";
      position:absolute;
      inset:2px;
      border-radius:999px;
      background:#000;
    }
    .field.radio.rd-tick input[type="checkbox"]:checked::after{
      content:"";
      position:absolute;
      left:5px;
      top:2px;
      width:calc(var(--rsize,18px) - 10px);
      height:calc(var(--rsize,18px) - 10px);
      border-right:2px solid #000;
      border-bottom:2px solid #000;
      transform:rotate(45deg);
    }

    .env-badge{display:none !important;}
  }

  .field.hasBorder input[type="text"],.field.hasBorder textarea{border:var(--bdw,2px) solid var(--bdc,#ff3b3b) !important;border-radius:8px;background:transparent;padding:6px 8px;}
  #printAll .field.hasBorder input[type="text"],#printAll .field.hasBorder textarea{border:var(--bdw,2px) solid var(--bdc,#ff3b3b) !important;border-bottom:none !important;border-radius:8px;}
  .field.hasBG input[type="text"],.field.hasBG textarea{background:var(--bgc,transparent) !important}
  #printAll .field.hasBG input[type="text"],#printAll .field.hasBG textarea{background:var(--bgc,transparent) !important}

  .affBanner{display:none;position:sticky;top:0;z-index:50;margin:6px 0 10px}
  .affBanner__card{background:#ffe08a;color:#2a2100;border:1px solid #cfa442;border-radius:10px;padding:10px 12px;font-weight:800}
  #affPopup{position:fixed;left:50%;transform:translateX(-50%);top:10px;z-index:99999;display:none}
  #affPopup .card b{font-weight:900}

  .extraBar{display:none;margin:6px 0 0}
  .extraBar__card{background:#0f2036;border:1px solid #2b3a54;border-radius:10px;padding:8px 10px;font-weight:800;color:#cfe0ff}
  .extraBar__label{opacity:.85;margin-right:8px}

  html.is-staging .env-badge{
    position:fixed;z-index:9999;top:10px;left:10px;
    padding:6px 10px;border-radius:6px;font-weight:700;
    background:#f59e0b;color:#111827;box-shadow:0 2px 6px rgba(0,0,0,.2);
    user-select:none;pointer-events:none;
  }
  html.is-prod .builder{display:none !important;}
  html.is-prod .hd .builder{display:none !important;}

  .btn-back{
    min-width: 140px;
    justify-content: center;
    font-weight: 700;
    font-size: 13px;
    padding: 6px 14px;
    text-decoration:none;
  }
  .btn-back::before{
    content: "←";
    margin-right: 4px;
    font-size: 14px;
  }

  /* =========================
     ✅ select 잘림 해결: select는 클릭만 / 표시는 div로 2줄+자동축소
  ========================= */
  .field.selectLike{ position:absolute; }
  .field.selectLike select{
    color: transparent !important;
    background: transparent !important;
    text-shadow: none !important;
  }
  .field.selectLike .select-display{
    position:absolute;
    inset:0;
    padding:0 6px;
    pointer-events:none;
    display:flex;
    align-items:center;
    justify-content:flex-start;
    white-space:normal;
    word-break:keep-all;
    overflow:hidden;
    line-height:1.15;
    font-weight:700;
    color:var(--fgc,#fff);
  }

  /* ✅ [추가] 인쇄 시 검정화면(오버레이/모달) 방지 */
  @media print{
    #msgModal,
    #docsModal,
    #comingSoonModal,
    #formModal,
    .modal, .cs-modal, .form-modal,
    .modal-backdrop, .cs-backdrop, .form-backdrop{
      display:none !important;
      visibility:hidden !important;
    }

    html, body{
      background:#fff !important;
    }

    /* 혹시 남아있는 fixed/overlay 계열 차단 */
    [style*="position: fixed"]{
      visibility:hidden !important;
    }
  }
@media print{
  /* 1) ✅ 라디오/체크 '원(input)' 테두리 제거 (투명 설정일 때) */
  #printAll .field.radio[style*="--tick-bdc: transparent"] input[type="checkbox"],
  #printAll .field.checkbox[style*="--tick-bdc: transparent"] input{
    border: 0 !important;
    border-color: transparent !important;
    outline: 0 !important;
    box-shadow: none !important;
  }

  /* 2) ✅ 라디오 '박스(.radio-item)' 테두리 제거 (투명 설정일 때) */
  #printAll .field.radio[style*="--rbc: transparent"] .radio-item{
    border: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
  }

  /* 3) (원하면) 라디오 박스 테두리를 그냥 무조건 다 없애기 — 위 2번이 안 먹을 때만 사용
  #printAll .field.radio .radio-item{
    border: 0 !important;
    background: transparent !important;
  }
  */
}

  /* ✅ (원하시면) 평상시에도 msgModal 자체를 사용 안 할 경우 */
  /* #msgModal{ display:none !important; } */
</style>

<script>
/* =========================
   ✅ ENV / URL 가드 (KT 단말 전용)
   (⚠️ 여기에는 조건부필수 함수 넣지 않습니다)
========================= */
(function(){
  const host = location.hostname;
  const IS_LOCAL   = /^(localhost|127\.0\.0\.1)$/i.test(host);
  const IS_STAGING = host.startsWith('staging.') || IS_LOCAL;

  document.documentElement.classList.toggle('is-staging', IS_STAGING);
  document.documentElement.classList.toggle('is-prod', !IS_STAGING);

  const qs = new URLSearchParams(location.search);
  const doc = (qs.get('doc') || 'device').toLowerCase();

  // ✅ 단말 페이지는 doc=device로 고정(다른 값이면 device로 정리)
  if (doc !== 'device') {
    qs.set('doc','device');
    const url = new URL(location.href);
    url.search = qs.toString();
    location.replace(url.toString());
    return;
  }

  const fav = document.querySelector('link[rel="icon"][sizes="32x32"]') || document.querySelector('link[rel="icon"]');
  if (IS_STAGING) {
    document.title = 'STAGING · ' + document.title.replace(/^STAGING ·\s*/,'');
    if (fav) fav.href = '/favicon-32x32.png?v=stg';

    const b = document.createElement('div');
    b.className = 'env-badge';
    b.textContent = 'STAGING (개발/테스트)';
    window.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(b));
  } else {
    document.title = document.title.replace(/^STAGING ·\s*/,'');
    if (fav) fav.href = '/favicon-32x32.png?v=prod';

    const url = new URL(location.href);
    if (!url.searchParams.has('mode')) {
      url.searchParams.set('mode','fill');
      history.replaceState(null,'',url.toString());
    }
    if (!url.searchParams.has('doc')) {
      url.searchParams.set('doc','device');
      history.replaceState(null,'',url.toString());
    }
  }
})();

(function(){
  function forceCloseForPrint(){
    const ids = ['msgModal','docsModal','comingSoonModal','formModal'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.setAttribute('aria-hidden','true');
      el.classList.remove('open');
      el.style.display = 'none';
    });

    document.querySelectorAll('.modal-backdrop,.cs-backdrop,.form-backdrop,.backdrop').forEach(b=>{
      b.style.display = 'none';
    });
  }

  window.addEventListener('beforeprint', forceCloseForPrint);
})();
/* ✅ 모든 입력에서 Enter 줄바꿈/제출 방지(동적 생성 포함) */
(function blockEnterEverywhere(){
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;

    const t = e.target;
    if (!t) return;

    // 입력 요소에서만 막기
    const isInputLike =
      t.tagName === 'TEXTAREA' ||
      (t.tagName === 'INPUT' && (t.type === 'text' || t.type === 'search' || t.type === 'tel' || t.type === 'number')) ||
      t.isContentEditable;

    if (!isInputLike) return;

    // (선택) Shift+Enter도 막기: 현재는 Enter면 전부 막음
    e.preventDefault();
  }, true);
})();

</script>
</head>

<body>
<div class="wrap">
  <section class="panel">
    <div class="hd">
      <strong>MCC · 미디어로그 단말 개통</strong>

      <div style="display:flex; gap:8px; align-items:center">
        <a href="../../../index.html" class="btn btn--ghost btn-back" id="backToHub">서류 선택 화면</a>
        <div class="builder">
          <button class="btn--ghost btn" id="enableWrapAll">모든 텍스트 자동 줄바꿈 켜기</button>
        </div>
      </div>
    </div>

    <div class="stack">
      <div id="affBanner" class="affBanner"><div class="affBanner__card">제휴 요금제 진행 시 <b> C-1 성함·동의 체크</b>가 필요합니다.</div></div>

      <div id="extraBar" class="extraBar">
        <div class="extraBar__card"><span class="extraBar__label">추가 데이터</span><span id="extraBarText"></span></div>
      </div>

      <div class="paper" id="paper">
        <div class="stage" id="stage">
          <img id="bg" src="" alt="">
          <div class="overlay" id="overlay"></div>
        </div>
      </div>

      <div class="pager">
        <button class="btn--ghost btn" id="prev">◀ 이전</button>
        <div id="pageInfo">1 / 1</div>
        <button class="btn--ghost btn" id="next">다음 ▶</button>
        <button class="btn" id="btnPdf">PDF 생성OR인쇄</button>
      </div>
      <p class="hint" style="text-align:center">필드를 클릭해 드래그로 이동. 입력은 컨트롤을 클릭 후 타이핑.</p>
    </div>
  </section>

  <section class="panel builder">
    <div class="hd">
      <strong>기본 도구</strong>
      <div>
        <button class="btn--ghost btn" id="reload">설계 다시읽기</button>
        <button class="btn--ghost btn" id="resetValues">값 초기화</button>
        <button class="btn" id="saveJson">설계 저장(JSON)</button>
      </div>
    </div>

    <div class="stack">
      <div class="group">
        <h4>새 필드</h4>
        <div class="row"><div>새 필드 타입</div>
          <select id="newType">
            <option value="text">텍스트박스</option>
            <option value="textarea">텍스트영역</option>
            <option value="select">드롭다운</option>
            <option value="radio">라디오(단일선택)</option>
            <option value="checkbox">체크박스</option>
          </select>
        </div>
        <div class="row"><div>새 필드 ID</div><input id="newId" placeholder="예: deviceId / planId / subsidy 등"></div>
        <div class="row"><div>라벨</div><input id="newLabel" placeholder="예: 단말 선택"></div>
        <div class="row"><div>옵션(콤마)</div><input id="newOpts" placeholder="라디오·드롭다운: 예) 12,24,36"></div>
        <div class="row"><div>필수</div><label><input type="checkbox" id="newReq"> 필수값</label></div>
        <div class="row"><button class="btn" id="addField">필드 추가</button></div>
      </div>

      <div id="propBox" class="group">
        <h4>선택한 필드 속성</h4>
        <div class="row"><div>선택된 항목</div><div id="selInfo" class="hint">없음</div></div>

        <div class="row"><div>라벨(선택)</div><input id="p_label" type="text" placeholder="라벨"></div>
        <div class="row"><div>필드 ID</div><input id="p_id" type="text" placeholder="예: deviceId / planId / msrp"></div>

        <div class="row" id="row_opts"><div>옵션(콤마)</div><input id="p_options" type="text" placeholder="예: 12, 24, 36"></div>
        <div class="row" id="row_req"><div>필수</div><label><input type="checkbox" id="p_required"> 반드시 작성</label></div>

        <div class="row"><div>X(%)</div><input id="p_x" type="number" step="0.1"></div>
        <div class="row"><div>Y(%)</div><input id="p_y" type="number" step="0.1"></div>
        <div class="row"><div>폭(%)</div><input id="p_w" type="number" step="0.1"></div>

        <div class="row"><div>라디오 크기(px)</div><input id="p_radioSize" type="number" min="10" max="32" step="1" placeholder="18"></div>
        <div class="row"><div>라디오 간격(px)</div><input id="p_radioGap" type="number" min="0" max="200" step="1" placeholder="12"></div>
        <div class="row" id="row_checkStyle">
          <div>체크 스타일</div>
          <select id="p_checkStyle">
            <option value="tick">✓ 체크</option>
            <option value="solid">■ 꽉찬</option>
            <option value="dot">● 점</option>
          </select>
        </div>

        <div class="row"><div>텍스트 색상</div><input id="p_color" type="color" value="#000000"></div>
        <div class="row"><div>입력 높이(px)</div><input id="p_height" type="number" min="5" max="60" step="1" placeholder="auto"></div>
        <div class="row"><div>글자 크기(px)</div><input id="p_fontSize" type="number" min="5" max="32" step="1" placeholder="14"></div>

        <div class="row"><div>정렬</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn--ghost btn" id="alignLeft">좌</button>
            <button class="btn--ghost btn" id="alignCX">가운데</button>
            <button class="btn--ghost btn" id="alignRight">우</button>
            <button class="btn--ghost btn" id="alignTop">상</button>
            <button class="btn--ghost btn" id="alignCY">중앙</button>
            <button class="btn--ghost btn" id="alignBottom">하</button>

            <div class="row"><div>텍스트 정렬</div>
              <select id="p_textAlign">
                <option value="">기본(좌측)</option>
                <option value="left">좌측</option>
                <option value="center">가운데</option>
                <option value="right">우측</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row"><div>입력 잠금</div>
          <label><input type="checkbox" id="p_locked"> 화면에서 타이핑 금지</label>
        </div>
        <div class="row"><div>placeholder 잠금</div>
          <label><input type="checkbox" id="p_lockOnPh"> placeholder만 표시(값 없으면 읽기전용)</label>
        </div>

        <div class="group" style="margin:8px 0 0;padding-top:8px">
          <h4>입력 제한(마스크)</h4>
          <div class="row"><div>패턴 선택</div>
            <select id="p_mask">
              <option value="">없음</option>
              <option value="number">숫자만</option>
              <option value="tel">전화번호(숫자-)</option>
              <option value="alpha">영문</option>
              <option value="alnum">영문+숫자</option>
              <option value="hangul">한글만</option>
              <option value="custom">사용자정의(정규식)</option>
            </select>
          </div>
          <div class="row"><div>허용 패턴(정규식)</div><input id="p_maskRe" type="text" placeholder="예: [0-9-], [A-Za-z], [가-힣0-9 ]"></div>
        </div>

        <div class="group" style="margin-top:8px">
          <h4>콘텐츠 설정</h4>
          <div class="row"><div>최대 글자 수</div><input id="p_maxlen" type="number" min="1" max="500" step="1"></div>
          <div class="row"><div>안내 문구(placeholder)</div><input id="p_placeholder" type="text" placeholder="예: 선납금 입력"></div>
          <div class="row"><div>자동 줄바꿈</div><label><input id="p_wrap" type="checkbox" checked> 사용</label></div>
          <div class="row"><div>자동 날짜</div>
            <select id="p_autoDate">
              <option value="">없음</option>
              <option value="year">년(YYYY)</option>
              <option value="month">월(MM)</option>
              <option value="day">일(DD)</option>
            </select>
          </div>
        </div>

        <div class="group" style="margin-top:8px">
          <h4>테두리/배경</h4>
          <div class="row"><div>테두리 색상</div><input id="p_borderColor" type="color" value="#ff3b3b"></div>
          <div class="row"><div>테두리 굵기(px)</div><input id="p_borderWidth" type="number" min="1" max="8" step="1" placeholder="2"></div>
          <div class="row"><div>테두리 투명</div><label><input type="checkbox" id="p_borderTransparent"> 사용</label></div>
          <div class="row"><div>배경 색상</div><input id="p_bgColor" type="color" value="#000000"></div>
          <div class="row"><div>배경 투명</div><label><input type="checkbox" id="p_bgTransparent"> 사용</label></div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn--ghost btn" id="applyProp">적용</button>
          <button class="btn--ghost btn" id="delField" style="margin-left:8px">삭제</button>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="printAll"></div>

<div class="toast" id="toast"><div class="toast__card">
  <b>작성되지 않은 필수 항목이 있습니다</b>
  <ul id="missList" style="margin:8px 0 0 18px;padding:0"></ul>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn--ghost btn" id="tClose">확인</button></div>
</div></div>

<div id="affPopup"><div class="card">⚠️ <b>제휴 요금제</b>입니다. <b> C-1 성함·동의 체크</b>가 모두 완료되어야 진행됩니다.</div></div>

<script>
/* =========================================================
   ✅ [핵심] BASE_URL: 현재 파일(index.html)이 있는 폴더 기준
========================================================= */
const BASE_URL = new URL('./', location.href);
const ABS = (p) => new URL(String(p || ''), BASE_URL).toString();

/* ✅ 조건부 필수 규칙 */
const CONDITIONAL_REQUIRED = [
  { sourceId: '신규/번이', whenValue: '신규',    requiredOn: ['희망번호'] },
  { sourceId: '신규/번이', whenValue: '번호이동', requiredOn: ['번호이동'] },
];

/* =========================
   ✅ 전역 값 저장/동기화
========================= */
const valuesById = Object.create(null);
const elById = Object.create(null);
let SHOW_INVALID = false;

function setValueById(id, value) {
  if (!id) return;
  const v = (value ?? "");

  // 1) 값 저장
  valuesById[id] = v;

  // 2) pages 설계에도 반영
  try {
    const key = String(id).toLowerCase();
    pages.forEach(pg => {
      (pg.fields || []).forEach(f => {
        if (String(f.id || '').toLowerCase() === key) {
          if (f.type === 'checkbox') f.value = !!value;
          else f.value = v;
        }
      });
    });
  } catch (_) {}

  // 3) ✅ 화면 DOM 반영: elById 없으면 id로 직접 찾기
  let el = elById[id];
  if (!el) el = document.getElementById(id);

  if (!el) return;

  // radio 더미객체면 값만 보관
  if (typeof el === 'object' && el.type === 'radio') {
    el.value = v;
    return;
  }

  // checkbox
  if (el.type === 'checkbox') {
    el.checked = !!value;
    return;
  }

  // input/textarea/select
  if ('value' in el) {
    el.value = v;

    // 값 넣었는데 UI/연산 로직이 안 따라오면 이벤트도 한번 쏴줌
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  } else {
    el.textContent = v;
  }
}

function applyAutoDateAll(){
  const d = new Date();
  const YYYY = String(d.getFullYear());
  const MM   = String(d.getMonth() + 1).padStart(2, '0');
  const DD   = String(d.getDate()).padStart(2, '0');

  pages.forEach(pg=>{
    (pg.fields || []).forEach(f=>{
      if(!f.autoDate) return;

      // 값이 비어있을 때만 자동 입력
      if(String(f.value || '').trim() !== '') return;

      if (f.autoDate === 'year')  f.value = YYYY;
      if (f.autoDate === 'month') f.value = MM;
      if (f.autoDate === 'day')   f.value = DD;

      if (f.id) setValueById(f.id, f.value);
    });
  });
}

function applyMirror(sourceField, value) {
  const targets = sourceField.mirrorTo || [];
  targets.forEach(tid => setValueById(tid, value));
}

/* ===== 모드/상태 ===== */
const QS  = new URLSearchParams(location.search);
const DOC = (QS.get('doc') || 'device').toLowerCase();
const FILL  = QS.get('mode') === 'fill';
const FRESH = QS.get('fresh') === '1';
if(FILL) document.documentElement.classList.add('fill');

let selected=-1;
let pages=[{bg:ABS('images/device-1.jpg'),fields:[]}], pageIndex=0;

/* ✅ age별 bg 강제 덮기 */
/* ✅ age별 bg 강제 덮기 (반드시 loadDesign()보다 위에 있어야 함) */
function getSafeAge(){
  const age = (new URLSearchParams(location.search).get('age') || 'adult').toLowerCase();
  return (age === 'teen') ? 'teen' : 'adult';
}

function forceAgeBgOnPages(){
  const safeAge = getSafeAge();
  const pageCount = pages.length || 8;

  for (let i = 0; i < pageCount; i++){
    if (!pages[i]) pages[i] = { bg:'', fields:[] };
    pages[i].bg = ABS(`images/${safeAge}-${i+1}.jpg`);
  }
}


const paper   = document.getElementById('paper');
const stage   = document.getElementById('stage');
const overlay = document.getElementById('overlay');
const bg      = document.getElementById('bg');
const pageInfo= document.getElementById('pageInfo');
const affBanner=document.getElementById('affBanner');
const affPopup = document.getElementById('affPopup');

const extraBar = document.getElementById('extraBar');
const extraBarText = document.getElementById('extraBarText');

let LAST_EXTRA_TXT = '';
let __MIRRORING__ = false;

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const num=(v,d)=>{const n=parseFloat(v);return isNaN(n)?d:n;};
const cur=()=>pages[pageIndex];

/* ===== 화면 줌 ===== */
function applyZoom(){
  stage.style.transform='scale(1)';
  const stageRect = stage.getBoundingClientRect();
  const targetW = paper.clientWidth;
  let z = targetW / Math.max(stageRect.width,1);
  z = Math.max(0.4, Math.min(2, z));
  document.documentElement.style.setProperty('--zoom', z);
  stage.style.transform = '';
  paper.style.height = (stage.offsetHeight * z) + 'px';
}
window.addEventListener('resize', applyZoom);

/* ===== 자동 저장 비활성 ===== */
const AUTOSAVE_KEY=null;
function scheduleSave(){ }
function tryLoadAutosave(){ }
const clearAutosave = () => { try { localStorage.removeItem(AUTOSAVE_KEY); } catch(_) {} };

/* ===== 드롭다운 글자 자동 축소 ===== */
function fitSelectText(sel, maxPx = 16, minPx = 8, arrowPx) {
  sel.style.fontSize = maxPx + 'px';
  try {
    const text = (sel.options[sel.selectedIndex] || {}).text || sel.value || '';
    const style = getComputedStyle(sel);
    const padL = parseFloat(style.paddingLeft) || 0;
    const padR = parseFloat(style.paddingRight) || 0;
    const ARROW_W = (typeof arrowPx === 'number') ? arrowPx : 0;
    const inner = sel.clientWidth - padL - padR - ARROW_W;
    if (inner <= 0 || !text) return;

    let meas = document.getElementById('__measure_span__');
    if (!meas) {
      meas = document.createElement('span');
      meas.id = '__measure_span__';
      meas.style.position = 'fixed';
      meas.style.visibility = 'hidden';
      meas.style.whiteSpace = 'nowrap';
      meas.style.left = '-9999px';
      document.body.appendChild(meas);
    }
    meas.style.fontFamily = style.fontFamily;
    meas.style.fontWeight = style.fontWeight;
    meas.style.fontStyle = style.fontStyle;
    meas.style.letterSpacing = style.letterSpacing;
    meas.style.textTransform = style.textTransform;

    for (let px = maxPx; px >= minPx; px -= 0.5) {
      meas.style.fontSize = px + 'px';
      meas.textContent = text;
      if (meas.getBoundingClientRect().width <= inner) {
        sel.style.fontSize = px + 'px';
        return;
      }
    }
    sel.style.fontSize = minPx + 'px';
  } catch (_) {}
}

function fitTextToWidth(el, maxPx = 20, minPx = 12){
  try{
    const raw = (el.value ?? '').toString();
    const text = raw.replace(/\n+/g,' ').trim();

    if(!text){
      el.classList.remove('fit-one-line');
      el.style.fontSize = maxPx + 'px';
      return;
    }

    el.classList.add('fit-one-line');
    el.style.fontSize = maxPx + 'px';

    const style = getComputedStyle(el);
    const padL = parseFloat(style.paddingLeft) || 0;
    const padR = parseFloat(style.paddingRight) || 0;
    const inner = el.clientWidth - padL - padR;
    if (inner <= 0) return;

    let meas = document.getElementById('__measure_span__');
    if (!meas) {
      meas = document.createElement('span');
      meas.id = '__measure_span__';
      meas.style.position = 'fixed';
      meas.style.visibility = 'hidden';
      meas.style.whiteSpace = 'nowrap';
      meas.style.left = '-9999px';
      document.body.appendChild(meas);
    }

    meas.style.fontFamily = style.fontFamily;
    meas.style.fontWeight = style.fontWeight;
    meas.style.fontStyle  = style.fontStyle;
    meas.style.letterSpacing = style.letterSpacing;
    meas.style.textTransform  = style.textTransform;

    for (let px = maxPx; px >= minPx; px -= 0.5) {
      meas.style.fontSize = px + 'px';
      meas.textContent = text;
      if (meas.getBoundingClientRect().width <= inner) {
        el.style.fontSize = px + 'px';
        return;
      }
    }
    el.style.fontSize = minPx + 'px';
  }catch(_){}
}

/* =========================
   ✅ select 표시 div: 2줄 허용 + 박스에 맞춰 자동 축소
========================= */
function fitSelectDisplay(div, maxPx = 20, minPx = 10){
  if(!div) return;
  try{
    div.style.fontSize = maxPx + 'px';

    for(let px = maxPx; px >= minPx; px -= 0.5){
      div.style.fontSize = px + 'px';
      const overH = div.scrollHeight > div.clientHeight + 1;
      const overW = div.scrollWidth  > div.clientWidth  + 1;
      if(!overH && !overW) return;
    }
    div.style.fontSize = minPx + 'px';
  }catch(_){}
}

function parsePackedId(v){
  const s = String(v||'');
  const i = s.indexOf('|');
  if(i<0) return { id:s.trim(), name:'' };
  return { id:s.slice(0,i).trim(), name:s.slice(i+1).trim() };
}

function setSelectDisplay(wrapEl, selEl, f){
  if(!wrapEl || !selEl) return;
  let d = wrapEl.querySelector('.select-display');
  if(!d){
    d = document.createElement('div');
    d.className = 'select-display';
    wrapEl.appendChild(d);
  }

  const text = (selEl.options[selEl.selectedIndex] || {}).textContent || '';
  d.textContent = text;

  const maxPx = Number.isFinite(f?.fontSize) ? f.fontSize : 20;
  fitSelectDisplay(d, maxPx, 10);
}

const refitAllSelects = () => {
  overlay.querySelectorAll('.field.selectLike').forEach(w => {
    const sel = w.querySelector('select');
    const idx = Number(w.dataset.i);
    const f = (Number.isFinite(idx) ? (cur().fields || [])[idx] : null);
    if(sel) setSelectDisplay(w, sel, f);
  });
};

/* ===== textarea 자동 높이 ===== */
function autosizeTA(el){
  try{
    if (el.dataset.fixedH) {
      el.style.height = el.dataset.fixedH + 'px';
      return;
    }
    const minH = parseFloat(el.dataset.minH || '') || 5;
    el.style.height = 'auto';
    el.style.height = Math.max(el.scrollHeight, minH) + 'px';
  }catch(_){}
}
function autosizeAllTextareas(root){
  (root || document).querySelectorAll('textarea').forEach(autosizeTA);
}

/* =========================================================
   ✅ 단말/요금제/공시 분리 로드
========================================================= */
const PATH_DEVICE_CATALOG = ABS('data/device_catalog.json');
const PATH_PLAN_CATALOG   = ABS('data/plan_catalog.json');
const PATH_SUBSIDY_LATEST = ABS('data/subsidy/latest.json');

let DEVICE_DB = null;

function won(n){
  if(n==null || n==='') return '';
  const x = Number(n);
  if(!isFinite(x)) return '';
  return String(Math.round(x));
}
function numOnly(v){
  const n = Number(String(v??'').replace(/[^\d.-]/g,''));
  return isFinite(n) ? n : 0;
}
function displayOnlyName(packed){
  const { id, name } = parsePackedId(packed);
  return name || id || '';
}

function findDeviceById(id){
  return (DEVICE_DB?.devices||[]).find(d => d.id === id) || null;
}
function findPlanById(id){
  return (DEVICE_DB?.plans||[]).find(p => p.id === id) || null;
}
function getSubsidy(deviceId, planId){
  if(!DEVICE_DB) return 0;

  const norm = s => String(s||'')
    .trim()
    .toLowerCase()
    .replace(/-/g,'_');

  const key = `${norm(deviceId)}|${norm(planId)}`;
  const v = DEVICE_DB.subsidyMap ? DEVICE_DB.subsidyMap[key] : 0;
  return Number(v)||0;
}

function calcMonthlyFeeSimple(principal, aprPercent){
  principal = Number(principal)||0;
  const r = (Number(aprPercent)||0) / 100 / 12;
  if (principal <= 0 || r <= 0) return 0;
  return principal * r;
}

async function fetchJson(url){
  const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(), { cache:'no-store' });
  if(!r.ok) throw new Error(`${url} not found (${r.status})`);
  return await r.json();
}

async function loadDevicePricingSeparated(){
  try{
    const [deviceCatalog, planCatalog, subsidyLatest] = await Promise.all([
      fetchJson(PATH_DEVICE_CATALOG),
      fetchJson(PATH_PLAN_CATALOG),
      fetchJson(PATH_SUBSIDY_LATEST),
    ]);

    const devices = Array.isArray(deviceCatalog.devices) ? deviceCatalog.devices : [];
    const plans   = Array.isArray(planCatalog.plans) ? planCatalog.plans : [];

    const subsidyMap = subsidyLatest.subsidyMap || {};
    const subsidyMeta = {
      effectiveFrom: subsidyLatest.effectiveFrom || '',
      effectiveTo: subsidyLatest.effectiveTo || '',
      memo: subsidyLatest.memo || '',
    };

    const aprPercent = (subsidyLatest.aprPercent != null)
      ? Number(subsidyLatest.aprPercent)
      : 5.8;

    const defaultInstallmentMonths = (subsidyLatest.defaultInstallmentMonths != null)
      ? Number(subsidyLatest.defaultInstallmentMonths)
      : 24;

    DEVICE_DB = {
      aprPercent,
      defaultInstallmentMonths,
      devices,
      plans,
      subsidyMeta,
      subsidyMap
    };

    console.log('[pricing] loaded OK', {
      deviceCount: devices.length,
      planCount: plans.length,
      subsidyKeys: Object.keys(subsidyMap||{}).length
    });
  }catch(err){
    console.warn('[pricing separated] load fail:', err);
    DEVICE_DB = null;
  }
}

/* ===== id로 전체 필드 탐색 ===== */
const getFieldsByIdAll=id=>{
  id=String(id||'').toLowerCase();
  const out=[];
  pages.forEach((pg,pi)=>(pg.fields||[]).forEach((f,idx)=>{
    if(String(f.id||'').toLowerCase()===id) out.push({f,pi,idx});
  }));
  return out;
};

function setOptionsByFieldId(fieldId, optionsArr){
  const list = getFieldsByIdAll(fieldId);
  list.forEach(({f})=>{
    if(f.type !== 'select') return;
    f.options = Array.isArray(optionsArr) ? optionsArr.slice() : [];
    if(f.value && !f.options.includes(f.value)) f.value = '';
  });
}

function applyDeviceDbToDesign(){
  if(!DEVICE_DB) return;

  const deviceOpts = (DEVICE_DB.devices||[]).map(d => `${d.id}|${d.name}`);
  setOptionsByFieldId('deviceId', deviceOpts);
  setOptionsByFieldId('deviceid', deviceOpts);

  const planOpts = (DEVICE_DB.plans||[]).map(p => `${p.id}|${p.name}`);
  setOptionsByFieldId('planId', planOpts);
  setOptionsByFieldId('plan', planOpts);

  const monthOpts = ['12','24','30','36'];
  setOptionsByFieldId('installMonths', monthOpts);

  const defM = String(Number(DEVICE_DB.defaultInstallmentMonths || 24));
  
  getFieldsByIdAll('installMonths').forEach(({f})=>{
    if(f.type==='select' && !f.value) f.value = defM;
  });
  // ✅ 기본값을 valuesById에도 확정(미러/텍스트필드가 바로 인식하게)
setValueById('installMonths', defM);
setValueById('installmonths', defM); // 혹시 소문자 id도 쓰면 같이

  render();
}

/* =========================================================
   ✅✅✅ 조건부 필수 함수 (정상 위치로 이동 완료)
   - getFieldsByIdAll 아래에 있어야 안전합니다.
========================================================= */
function normalizeVal(v){
  return (v ?? '').toString().trim();
}

function getFieldCurrentValueById(id){
  const v = valuesById[id];
  if (v != null) return v;

  const found = getFieldsByIdAll(id)[0]?.f;
  return found ? found.value : '';
}

function getConditionalRequiredSet(){
  const set = new Set();

  (CONDITIONAL_REQUIRED || []).forEach(rule => {
    const curVal = normalizeVal(getFieldCurrentValueById(rule.sourceId));
    if (curVal === normalizeVal(rule.whenValue)) {
      (rule.requiredOn || []).forEach(tid => set.add(tid));
    }
  });

  return set;
}

function refreshConditionalInvalid(){
   if (!SHOW_INVALID) return;
  const condReq = getConditionalRequiredSet();

  // 현재 페이지 invalid 초기화
  overlay.querySelectorAll('.field.invalid').forEach(el=>el.classList.remove('invalid'));

  const pg = cur();
  (pg.fields || []).forEach((f, idx) => {
    const fid = (f.id || '').toString();
    const isRequired = !!f.required || (fid && condReq.has(fid));
    if(!isRequired) return;

    const v = (f.type==='checkbox') ? !!f.value : (f.value ?? '').toString().trim();
    if(!v){
      const el = overlay.querySelector(`.field[data-i="${idx}"]`);
      if(el) el.classList.add('invalid');
    }
  });
}

/* =========================================================
   ✅ 요금 계산
========================================================= */
function recalcDevicePricing(){
  if(!DEVICE_DB) return;

  const rawDevice = (valuesById.deviceId || valuesById.deviceid || '');
  const rawPlan   = (valuesById.planId   || valuesById.plan     || '');

  const dv = parsePackedId(rawDevice);
  const pl = parsePackedId(rawPlan);

  const months  = numOnly(valuesById.installMonths ?? DEVICE_DB.defaultInstallmentMonths ?? 24);
  const payType = (valuesById.payType ?? '').toString().trim(); // ✅ 여기 1번만

  if(!dv.id || !pl.id){
    [
       'deviceName','msrp','commonSubsidy','extraSubsidy','otherDiscount',
    'principal','monthlyInstall','monthlyFeeAvg','monthlyPayTotal',
    'baseFee','discountFee','totalFee','monthlyBasePay','planEcho',
    'penalty12','penalty18'
    ].forEach(id => setValueById(id,''));
    return;
  }

  const dev  = findDeviceById(dv.id);
  const plan = findPlanById(pl.id);

  setValueById('planEcho', plan?.name || '');

  const msrp         = Number(dev?.msrp) || 0;
  const commonSubsidy= getSubsidy(dv.id, pl.id);

  const down     = numOnly(valuesById.downPayment ?? 0);
  const otherDis = numOnly(valuesById.otherDiscount ?? 0);

  const totalSupport = commonSubsidy + down;
setValueById('totalSupport', won(totalSupport));
setValueById('supportSum',  won(totalSupport));

  let extraSub = numOnly(valuesById.extraSubsidy ?? 0);
  let principal = 0;

  if (payType === '일시불') {
    extraSub  = Math.max(0, msrp - commonSubsidy);
    principal = 0;

    setValueById('extraSubsidy', won(extraSub));
    setValueById('downPayment',  '0');
    setValueById('otherDiscount','0');
      // ✅ (권장) 일시불에서도 공시+선납 합계 표기(선납은 0으로 강제된 값 기준)
  setValueById('supportSum', won(commonSubsidy + 0));

} else {
  // 할부
  extraSub = 0;
  setValueById('extraSubsidy', '0');

  // ✅ LG: 공시+선납 합계
  const supportSum = commonSubsidy + down; // commonSubsidy + downPayment
  setValueById('supportSum', won(supportSum)); // 디자인에 supportSum 텍스트필드가 있으면 표기

  // ✅ principal = msrp - (공시+선납) - 기타할인
  principal = Math.max(0, msrp - supportSum - otherDis);
}


  // ✅ 월 할부/수수료 계산
  const monthlyInstallRaw = (months > 0) ? (principal / months) : 0;
  const monthlyFeeAvgRaw  = calcMonthlyFeeSimple(principal, DEVICE_DB.aprPercent ?? 0);

  const monthlyInstallWon  = Math.round(monthlyInstallRaw);
  const monthlyFeeAvgWon   = Math.round(monthlyFeeAvgRaw);
  const monthlyPayTotalWon = monthlyInstallWon + monthlyFeeAvgWon;
  const totalFeeByAvgWon = Math.round(monthlyFeeAvgWon * months);
setValueById('totalFeeByAvg', String(totalFeeByAvgWon));


  setValueById('deviceName',     dev?.name || '');
  setValueById('msrp',           won(msrp));
  setValueById('commonSubsidy',  won(commonSubsidy));
  setValueById('extraSubsidy',   won(extraSub));
  setValueById('otherDiscount',  won(otherDis));
  setValueById('principal',      won(principal));

  // ✅ 위약금(12개월/18개월) = 공시지원금 기준
// 12개월: 공시지원금의 절반
// 18개월: 12개월 위약금의 절반 (= 공시지원금의 1/4)
const penalty12 = Math.round((commonSubsidy || 0) / 2);
const penalty18 = Math.round(penalty12 / 2);

setValueById('penalty12', won(penalty12));
setValueById('penalty18', won(penalty18));


if (payType === '일시불') {
  setValueById('monthlyInstall', '0');
  setValueById('monthlyFeeAvg',  '0');
  setValueById('monthlyPayTotal','0');

  // ✅ 총 할부수수료도 0
  setValueById('installFeeTotal','0');
} else {
  setValueById('monthlyInstall',  String(monthlyInstallWon));
  setValueById('monthlyFeeAvg',   String(monthlyFeeAvgWon));
  setValueById('monthlyPayTotal', String(monthlyPayTotalWon));

  // ✅ 총 할부수수료 = 월 평균할부수수료 * 할부개월수
  const installFeeTotalWon = monthlyFeeAvgWon * Math.max(0, months);
  setValueById('installFeeTotal', String(installFeeTotalWon));
}


  // ✅ 요금제 금액
  if (plan) {
    const base  = Number(plan.baseFee);
    const total = Number(plan.totalFee);

    let discount = plan.discountFee;
    if (discount == null || discount === '') {
      discount = (isFinite(base) && isFinite(total)) ? (base - total) : 0;
    }
    discount = Number(discount);
    if (!isFinite(discount)) discount = 0;

    setValueById('baseFee',     won(isFinite(base) ? base : 0));
    setValueById('discountFee', won(discount));
    setValueById('totalFee',    won(isFinite(total) ? total : (isFinite(base) ? base - discount : 0)));
  } else {
    setValueById('baseFee', '');
    setValueById('discountFee', '');
    setValueById('totalFee', '');
  }

  // ✅ A(단말 월납부) + B(통신요금 월납부)
  const A = numOnly(valuesById.monthlyPayTotal ?? 0);
  const B = numOnly(valuesById.totalFee ?? 0);
  setValueById('monthlyBasePay', won(A + B));
}

let __DEVICE_RECALC_HOOKED__ = false;
function hookDeviceRecalc(){
  if (__DEVICE_RECALC_HOOKED__) return;

  const ids = ['deviceId','deviceid','planId','plan','installMonths','downPayment','extraSubsidy','otherDiscount','payType'];
  let hookedAny = false;

  ids.forEach(id=>{
    const el = elById[id];
    if(!el || !el.addEventListener) return;
    el.addEventListener('change', recalcDevicePricing);
    el.addEventListener('input', recalcDevicePricing);
    hookedAny = true;
  });

  if (hookedAny) __DEVICE_RECALC_HOOKED__ = true;
}

/* =========================
   ✅ 설계 로드
========================= */
function seedDevicePages(){
  const age = (new URLSearchParams(location.search).get('age') || 'adult').toLowerCase();
  const safeAge = (age === 'teen') ? 'teen' : 'adult';

  const pageCount = 8;

  pages = [...Array(pageCount)].map((_, i) => ({
    bg: ABS(`images/${safeAge}-${i+1}.jpg`),
    fields: []
  }));
}

function designFileOf(doc){
  doc = String(doc||'device').toLowerCase();
  if (doc !== 'device') doc = 'device';

  const age = getSafeAge(); // teen/adult

  return [
    `overlay-design.${doc}.${age}.json`,   // ✅ 1순위: age별
    `overlay-design.${doc}.json`,          // 2순위: 공통
    `overlay-design.json`                  // 3순위: 최후 fallback
  ];
}


function buildDesignUrls(){
  return designFileOf(DOC).map(f => ABS(f) + (f.includes('?') ? '&' : '?') + 'v=' + Date.now());
}

function normalizeBgUrls(){
  pages.forEach(pg=>{
    if (!pg) return;
    if (pg.bg) pg.bg = ABS(pg.bg);
    else pg.bg = ABS('images/device-1.jpg');
    if (!Array.isArray(pg.fields)) pg.fields = [];
  });
}

async function loadDesign(){
  const urls = buildDesignUrls();
  console.log('[loadDesign] try urls:', urls);

  let ok = false;

  for (const url of urls){
    try{
      const r = await fetch(url, { cache: 'no-store' });
      console.log('[loadDesign] fetch', r.status, url, 'ct=', r.headers.get('content-type'));

      if (!r.ok) continue;

      // 서버가 404 HTML을 200으로 주는 케이스 방지
      const txt = await r.text();
      try{
        const j = JSON.parse(txt);
        if (Array.isArray(j.pages) && j.pages.length){
          pages = j.pages;
          ok = true;
          console.log('[loadDesign] loaded OK from:', url, 'pages=', pages.length);
          break;
        } else {
          console.warn('[loadDesign] JSON ok but no pages:', url, j);
        }
      }catch(e){
        console.warn('[loadDesign] JSON parse fail:', url, e, 'first200=', txt.slice(0,200));
      }

    }catch(e){
      console.warn('[loadDesign] fetch fail:', url, e);
    }
  }

  if (!ok){
    console.warn('[loadDesign] no design found => seedDevicePages()');
    seedDevicePages();
  }

  forceAgeBgOnPages();
  normalizeBgUrls();
  pageIndex = 0;
}

/* ===== 자필(잠금) 키 입력 방지 ===== */
function blockTyping(el){
  const prevent = e=>{ if(e.key !== 'Tab') e.preventDefault(); };
  el.addEventListener('keydown', prevent);
  el.addEventListener('beforeinput', e=>e.preventDefault());
  el.addEventListener('paste', e=>e.preventDefault());
}

/* =========================
   ✅ render()
========================= */
function render(){
  Object.keys(elById).forEach(k => delete elById[k]);

  const p = cur();
 bg.src = (p.bg ? (p.bg + (p.bg.includes('?') ? '&' : '?') + 'v=' + Date.now()) : ''); 
  overlay.innerHTML = '';

  (p.fields || []).forEach((f, i) => {
    if (Number.isFinite(f.fontSize))     f.fontSize     = clamp(f.fontSize, 5, 32);
    if (Number.isFinite(f.inputHeight))  f.inputHeight  = clamp(f.inputHeight, 5, 60);

    const w = document.createElement('div');
    w.className = 'field '
      + (f.type === 'radio'    ? 'radio '    : '')
      + (f.type === 'checkbox' ? 'checkbox ' : '')
      + (i === selected        ? ' sel'      : '');

    if (f.type === 'checkbox' || f.type === 'radio') {
      const tickColor = (f.borderTransparent) ? 'transparent' : (f.borderColor || '#000');
      const tickWidth = Number.isFinite(Number(f.borderWidth))
        ? Math.max(0, Math.min(8, Number(f.borderWidth)))
        : 1.6;
      w.style.setProperty('--tick-bdc', tickColor);
      w.style.setProperty('--tick-bdw', tickWidth + 'px');
    }

    const _w = (f.w ?? 24);
    w.style.left  = `${f.x}%`;
    w.style.top   = `${f.y}%`;
    w.style.width = `${_w}%`;
    if (f.fontSize) w.style.setProperty('--fs', f.fontSize + 'px');
    w.dataset.i = i;
    if (f.id) w.dataset.id = f.id;

    if (f.type === 'radio') {
      w.style.setProperty('--rsize', (f.radioSize ?? 18) + 'px');
      w.style.setProperty('--rgap',  (f.radioGap  ?? 12) + 'px');

      const rs = (f.radioStyle || 'dot');
      w.classList.remove('rd-dot','rd-solid','rd-tick');
      w.classList.add('rd-' + rs);

      if (f.radioShowText === false) w.classList.add('noText');
      else w.classList.remove('noText');

      const outerColor = (f.radioOuterBorderTransparent || f.borderTransparent) ? 'transparent'
                        : (f.radioOuterBorderColor || 'rgba(0,0,0,.25)');
      const outerWidth = Number.isFinite(Number(f.radioOuterBorderWidth))
        ? Math.max(0, Math.min(8, Number(f.radioOuterBorderWidth)))
        : 1;

      w.style.setProperty('--rbc', outerColor);
      w.style.setProperty('--rbw', outerWidth + 'px');
    }

    if (f.color) w.style.setProperty('--fgc', f.color);
    if (f.inputHeight) w.style.setProperty('--ih', f.inputHeight + 'px');

    const lab = document.createElement('div');
    lab.className   = 'label';
    lab.textContent = f.label || '';
    w.appendChild(lab);

    let ctrl;
    const lockByPlaceholder = !!f.lockOnPh && !!f.placeholder && !f.value;

    const treatAsTextarea =
      (f.type === 'textarea') ||
      (f.type === 'text' && (f.wrap));

    if (treatAsTextarea) {
      ctrl = document.createElement('textarea');
      ctrl.spellcheck = false;
      ctrl.style.resize = 'none';

      const init = (f.id ? (valuesById[f.id] ?? f.value ?? "") : (f.value ?? ""));
      ctrl.value = init;
      f.value = init;
      if (f.id) elById[f.id] = ctrl;

      if (f.placeholder) ctrl.placeholder = f.placeholder;
      if (f.maxLength)   ctrl.maxLength = f.maxLength;

      if (f.inputHeight) {
        ctrl.dataset.fixedH = f.inputHeight;
        ctrl.style.height = f.inputHeight + 'px';
      }

      if (f.locked || lockByPlaceholder) {
        ctrl.readOnly = true;
        ctrl.dataset.locked = '1';
        blockTyping(ctrl);
      }

      ctrl.oninput = () => {
        if (f.locked || lockByPlaceholder) return;
        let v = ctrl.value;
        if (f.maxLength) v = v.slice(0, f.maxLength);
        if (ctrl.value !== v) ctrl.value = v;

        f.value = v;
        setValueById(f.id, v);
        applyMirror(f, v);

        autosizeTA(ctrl);
        scheduleSave();
        if (f.id === 'downPayment') recalcDevicePricing();

        refreshConditionalInvalid();
      };
    }
    else if (f.type === 'select') {
      const sel = document.createElement('select');
      w.classList.add('selectLike');

      const init = (f.id ? (valuesById[f.id] ?? f.value ?? "") : (f.value ?? ""));
      f.value = init;

      const phText = (f.placeholder || '').trim();
      if (phText) {
        const op0 = document.createElement('option');
        op0.value = '';
        op0.textContent = phText;
        op0.disabled = true;
        op0.hidden = true;
        sel.appendChild(op0);
      }

      (f.options || []).forEach(o => {
        const packed = String(o ?? '');
        const { id, name } = parsePackedId(packed);

        const op = document.createElement('option');
        op.value = id || packed;
        op.textContent = name || id || packed;
        sel.appendChild(op);
      });

      sel.value = parsePackedId(init ?? '').id || '';

      sel.style.color = (f.color || '#000');
      sel.style.caretColor = (f.color || '#000');
      sel.style.backgroundColor = (f.bgTransparent ? 'transparent' : (f.bgColor || 'transparent'));
      sel.querySelectorAll('option').forEach(op => {
        op.style.color = '#000';
        op.style.backgroundColor = '#fff';
      });

      if (f.id) elById[f.id] = sel;
      if (f.inputHeight) sel.style.height = f.inputHeight + 'px';

      if (f.locked || lockByPlaceholder) {
        sel.disabled = true;
        sel.dataset.locked = '1';
      }

      sel.onchange = () => {
        if (sel.value === '') return;

        f.value = sel.value;
        setValueById(f.id, sel.value);
        applyMirror(f, sel.value);

        scheduleSave();
        setSelectDisplay(w, sel, f);

        if (f.id === 'deviceId' || f.id === 'planId' || f.id === 'installMonths') {
          recalcDevicePricing();
        }

        // ✅ 어떤 select가 바뀌든 조건부필수 표시 갱신
        refreshConditionalInvalid();
      };

      requestAnimationFrame(() => setSelectDisplay(w, sel, f));
      ctrl = sel;
    }
    else if (f.type === 'checkbox') {
      ctrl = document.createElement('input');
      ctrl.type = 'checkbox';

      const init = (f.id ? (valuesById[f.id] ?? f.value ?? false) : (f.value ?? false));
      ctrl.checked = !!init;
      f.value = !!init;
      if (f.id) elById[f.id] = ctrl;

      if (f.locked || lockByPlaceholder){
        ctrl.disabled = true;
        ctrl.dataset.locked = '1';
      }

      w.style.setProperty('--cksize', (f.checkSize ?? f.radioSize ?? 18) + 'px');

      const style = (f.checkStyle || 'tick');
      w.classList.remove('ck-tick','ck-solid','ck-dot');
      w.classList.add('ck-' + style);

      ctrl.onchange = () => {
        f.value = ctrl.checked;
        setValueById(f.id, ctrl.checked);
        applyMirror(f, ctrl.checked);
        scheduleSave();

        refreshConditionalInvalid();
      };

      lab.style.top  = '0';
      lab.style.left = '24px';
    }
    else if (f.type === 'radio') {
      ctrl = document.createElement('div');
      const opts = (f.options && f.options.length)
        ? f.options
        : Array.from({ length: (f.radioCount || 2) }, (_, k) => String(k + 1));

      const init = (f.id ? (valuesById[f.id] ?? f.value ?? '') : (f.value ?? ''));
      f.value = init;
      if (f.id) elById[f.id] = { type:'radio', value:init };

      opts.forEach(o => {
        const it = document.createElement('label');
        it.className = 'radio-item';

        const cb = document.createElement('input');
        cb.type  = 'checkbox';
        cb.value = o;
        cb.checked = (f.value === o);
        if (f.locked || lockByPlaceholder) cb.disabled = true;

        cb.onchange = () => {
          if (!cb.checked) return;
          ctrl.querySelectorAll('input[type="checkbox"]').forEach(x => {
            if (x !== cb) x.checked = false;
          });
          f.value = o;
          setValueById(f.id, o);
          applyMirror(f, o);
          scheduleSave();

            // ✅✅✅ 추가: 라디오 변경 즉시 재계산
  if (f.id === 'payType') recalcDevicePricing();


          refreshConditionalInvalid();
        };

        const hideText = (f.radioShowText === false) || /^\d+$/.test(String(o).trim());
        if (!hideText) {
          const s = document.createElement('span');
          s.textContent = o;
          it.appendChild(s);
        }
        it.appendChild(cb);
        ctrl.appendChild(it);
      });
    }
    else {
      ctrl = document.createElement('input');
      ctrl.type = 'text';

      const init = (f.id ? (valuesById[f.id] ?? f.value ?? "") : (f.value ?? ""));
      ctrl.value = init;
      f.value = init;
      if (f.id) elById[f.id] = ctrl;

      if (f.placeholder) ctrl.placeholder = f.placeholder;
      if (f.maxLength)   ctrl.maxLength  = f.maxLength;

      if (f.locked || lockByPlaceholder){
        ctrl.readOnly = true;
        ctrl.dataset.locked = '1';
        blockTyping(ctrl);
      }

      ctrl.oninput = () => {
        if (f.locked || lockByPlaceholder) return;
        let v = ctrl.value;
        if (f.maxLength) v = v.slice(0, f.maxLength);
        if (ctrl.value !== v) ctrl.value = v;

        f.value = v;
        setValueById(f.id, v);
        applyMirror(f, v);

        scheduleSave();
        if (f.id === 'downPayment') recalcDevicePricing();
        fitTextToWidth(ctrl, (Number.isFinite(f.inputHeight) ? (f.inputHeight - 4) : (f.fontSize ?? 20)), 12);

        refreshConditionalInvalid();
      };
    }

    if (f.color) ctrl.style.color = f.color;

    if (f.textAlign) {
      ctrl.style.textAlign = f.textAlign;
      w.style.setProperty('--ta', f.textAlign);
    } else {
      w.style.removeProperty('--ta');
      ctrl.style.textAlign = '';
    }

    if ((f.type === 'text' || f.type === 'textarea') && (f.borderColor || f.borderTransparent)) {
      w.classList.add('hasBorder');
      w.style.setProperty('--bdc', f.borderTransparent ? 'transparent' : (f.borderColor || '#ff3b3b'));
      w.style.setProperty('--bdw', (f.borderWidth ?? 2) + 'px');
    } else {
      w.classList.remove('hasBorder');
      w.style.removeProperty('--bdc');
      w.style.removeProperty('--bdw');
    }

    if ((f.type === 'text' || f.type === 'textarea') && (f.bgColor || f.bgTransparent)) {
      w.classList.add('hasBG');
      w.style.setProperty('--bgc', f.bgTransparent ? 'transparent' : (f.bgColor || 'transparent'));
    } else {
      w.classList.remove('hasBG');
      w.style.removeProperty('--bgc');
    }

    if (ctrl && (ctrl.tagName === 'INPUT' || ctrl.tagName === 'TEXTAREA')) {
      if (ctrl.tagName === 'INPUT') {
        requestAnimationFrame(() => {
          const maxPx = Number.isFinite(f.inputHeight) ? (f.inputHeight - 4) : (f.fontSize ?? 20);
          fitTextToWidth(ctrl, maxPx, 12);
        });
      }
    }

    if (FILL) ctrl.addEventListener('mousedown', e => e.stopPropagation());

    if (f.id) {
      w.setAttribute('data-fid', f.id);
      if (ctrl && ctrl.setAttribute) {
        ctrl.id = f.id;
        ctrl.name = f.id;
        ctrl.setAttribute('data-fid', f.id);
      }
    }

    w.appendChild(ctrl);
    overlay.appendChild(w);

    if (!FILL && (f.type === 'text' || f.type === 'textarea' || f.type === 'select' || f.type === 'radio')) {
      const rh = document.createElement('div');
      rh.className = 'resize-handle';
      rh.addEventListener('mousedown', ev => startResize(ev, i, w));
      w.appendChild(rh);
    }

    if (!FILL) {
      w.addEventListener('mousedown', e => startDrag(e, i, w));
      w.addEventListener('click', () => select(i));
    }
  });

  if (!FILL) updatePanel();
  pageInfo.textContent = `${pageIndex + 1} / ${pages.length}`;

  requestAnimationFrame(refitAllSelects);
  requestAnimationFrame(() => autosizeAllTextareas(overlay));

  requestAnimationFrame(() => {
    hookDeviceRecalc();
    recalcDevicePricing();
    refreshConditionalInvalid();
  });
}

/* ===== 속성 패널 ===== */
const pLabel=document.getElementById('p_label'),
      pRadioSize=document.getElementById('p_radioSize'),
      pRadioGap=document.getElementById('p_radioGap'),
      pColor=document.getElementById('p_color'),
      pHeight=document.getElementById('p_height'),
      pId=document.getElementById('p_id'),
      pOptions=document.getElementById('p_options'),
      pRequired=document.getElementById('p_required'),
      pBorderColor=document.getElementById('p_borderColor'),
      pBorderWidth=document.getElementById('p_borderWidth'),
      pBorderTransparent=document.getElementById('p_borderTransparent'),
      pBgColor=document.getElementById('p_bgColor'),
      pBgTransparent=document.getElementById('p_bgTransparent'),
      pFontSize=document.getElementById('p_fontSize'),
      pTextAlign=document.getElementById('p_textAlign'),
      pMask=document.getElementById('p_mask'),
      pMaskRe=document.getElementById('p_maskRe'),
      pMaxLen=document.getElementById('p_maxlen'),
      pPlaceholder=document.getElementById('p_placeholder'),
      pAutoDate=document.getElementById('p_autoDate'),
      pLocked=document.getElementById('p_locked'),
      pLockOnPh=document.getElementById('p_lockOnPh'),
      pCheckStyle=document.getElementById('p_checkStyle');

function updatePanel(){
  const info=document.getElementById('selInfo'),
        px=document.getElementById('p_x'),
        py=document.getElementById('p_y'),
        pw=document.getElementById('p_w'),
        rowOpts=document.getElementById('row_opts'),
        rowReq=document.getElementById('row_req');

  if(selected<0){
    info.textContent='없음'; px.value=py.value=pw.value='';
    pLabel.value=''; pRadioSize.value=''; pRadioGap.value='';
    pColor.value='#000000'; pHeight.value=''; pId.value='';
    pBorderColor.value='#ff3b3b'; pBorderWidth.value=2; pBorderTransparent.checked=false;
    pBgColor.value='#000000'; pBgTransparent.checked=false;
    pFontSize.value=''; pMask.value=''; pMaskRe.value=''; pMaxLen.value=''; pPlaceholder.value='';
    pAutoDate.value=''; pLocked.checked=false; pLockOnPh.checked=false;
    if(rowOpts) rowOpts.style.display='none'; if(rowReq) rowReq.style.display='none';
    if (pCheckStyle) pCheckStyle.value = 'tick';
    return;
  }

  const f=cur().fields[selected];
  info.textContent=(f.label||f.id||('필드'+(selected+1)));
  px.value=f.x; py.value=f.y; pw.value=f.w ?? 24;
  pLabel.value = f.label || '';

  pRadioSize.value = (f.type === 'checkbox') ? (f.checkSize ?? 18) : (f.radioSize ?? 18);
  pRadioGap.value = (f.radioGap ?? 12);

  pColor.value=(f.color || '#000000');
  pHeight.value=(f.inputHeight ?? '');
  pId.value=f.id || '';

  pBorderColor.value=f.borderTransparent?'#000000':(f.borderColor||'#ff3b3b');
  pBorderWidth.value=(f.borderWidth ?? 2);
  pBorderTransparent.checked=!!f.borderTransparent;

  pBgColor.value=f.bgTransparent?'#000000':(f.bgColor||'#000000');
  pBgTransparent.checked=!!f.bgTransparent;

  if(rowReq) rowReq.style.display='';
  if(pRequired) pRequired.checked=!!f.required;

  if(rowOpts) rowOpts.style.display=(f.type==='select'||f.type==='radio')?'':'none';
  if(pOptions) pOptions.value=Array.isArray(f.options)? f.options.join(', ') : '';

  pFontSize.value = (f.fontSize ?? 14);
  pTextAlign.value = f.textAlign || '';
  pMask.value = f.mask || '';
  pMaskRe.value = (f.maskRe || '');
  pMaxLen.value = f.maxLength || '';
  pPlaceholder.value = f.placeholder || '';
  pAutoDate.value = f.autoDate || '';
  pLocked.checked = !!f.locked;
  pLockOnPh.checked = !!f.lockOnPh;

  if (pCheckStyle) {
    if (f.type === 'checkbox') pCheckStyle.value = (f.checkStyle || 'tick');
    else if (f.type === 'radio') pCheckStyle.value = (f.radioStyle || 'dot');
    else pCheckStyle.value = 'tick';
  }
}
const select=i=>{selected=i; render();};

/* ===== 드래그 ===== */
function startDrag(e, i, el){
  if (FILL) return;
  e.stopPropagation(); e.preventDefault();

  const f    = cur().fields[i];
  const rect = stage.getBoundingClientRect();
  const fieldRect = el.getBoundingClientRect();
  const offsetX   = e.clientX - fieldRect.left;
  const offsetY   = e.clientY - fieldRect.top;

  document.body.style.userSelect = 'none';
  paper.style.cursor = 'move';

  function move(ev){
    const relX = ev.clientX - rect.left - offsetX;
    const relY = ev.clientY - rect.top  - offsetY;

    const nx = clamp((relX / rect.width)  * 100, 0, 100);
    const ny = clamp((relY / rect.height) * 100, 0, 100);

    f.x = nx; f.y = ny;
    el.style.left = nx + '%';
    el.style.top  = ny + '%';
  }
  function up(){
    window.removeEventListener('mousemove', move);
    window.removeEventListener('mouseup', up);
    document.body.style.userSelect = '';
    paper.style.cursor = '';
    scheduleSave();
  }
  window.addEventListener('mousemove', move);
  window.addEventListener('mouseup', up);
}

/* ===== 리사이즈 ===== */
function startResize(e, i, el){
  e.stopPropagation(); e.preventDefault();

  const f = cur().fields[i];
  const r = stage.getBoundingClientRect();

  const startX = e.clientX;
  const startY = e.clientY;
  const startWpx = ((f.w ?? 24) / 100) * r.width;
  const startHpx = f.inputHeight || el.offsetHeight;

  document.body.style.userSelect = 'none';
  paper.style.cursor = 'nwse-resize';

  function mv(ev){
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    const newWpx = Math.max(40, startWpx + dx);
    const newW   = clamp((newWpx / r.width) * 100, 2, 95);
    f.w = newW;
    el.style.width = newW + '%';

    const newH = clamp(startHpx + dy, 5, 200);
    f.inputHeight = newH;
    el.style.setProperty('--ih', newH + 'px');
  }
  function up(){
    window.removeEventListener('mousemove', mv);
    window.removeEventListener('mouseup', up);
    document.body.style.userSelect = '';
    paper.style.cursor = '';
    scheduleSave();
  }
  window.addEventListener('mousemove', mv);
  window.addEventListener('mouseup', up);
}

/* ===== 필드 추가/적용/삭제 ===== */
document.getElementById('addField').onclick=()=>{
  const t=document.getElementById('newType').value,
        id=document.getElementById('newId').value.trim(),
        label=document.getElementById('newLabel').value.trim(),
        opts=document.getElementById('newOpts').value.split(',').map(s=>s.trim()).filter(Boolean),
        req=document.getElementById('newReq').checked;
  const base={id:(id||`${t}_${Date.now()}`),label,type:t,x:50,y:50,w:30,required:req};
  if(t==='select'||t==='radio') base.options=opts;
  if(t==='radio'){ base.radioSize=18; base.radioGap=12; }
  cur().fields.push(base); selected=cur().fields.length-1; render(); scheduleSave();
};

document.getElementById('applyProp').onclick = () => {
  if (selected < 0) return;

  const f = cur().fields[selected];
  const style = (pCheckStyle?.value || 'tick');

  if (f.type === 'checkbox') f.checkStyle = style;
  if (f.type === 'radio')    f.radioStyle = style;

  f.x = clamp(num(document.getElementById('p_x').value, f.x), 0, 100);
  f.y = clamp(num(document.getElementById('p_y').value, f.y), 0, 100);
  f.w = clamp(num(document.getElementById('p_w').value, f.w ?? 24), 2, 95);
  f.label = (pLabel?.value || '').trim();

  const sizeInput = num(pRadioSize?.value, (f.checkSize ?? f.radioSize ?? 18));
  const safeSize  = clamp(sizeInput, 8, 40);
  f.radioSize = safeSize;
  f.checkSize = safeSize;
  f.radioGap  = clamp(num(pRadioGap?.value, f.radioGap ?? 12), 0, 200);

  f.color = pColor?.value || '#000000';

  const h = parseInt(pHeight?.value, 10);
  f.inputHeight = Number.isFinite(h) ? clamp(h, 5, 60) : undefined;

  f.wrap = !!document.getElementById('p_wrap')?.checked;

  f.id = (pId?.value || '').trim() || f.id;
  f.required = !!pRequired?.checked;

  f.borderTransparent = !!pBorderTransparent?.checked;
  f.borderColor = f.borderTransparent
    ? 'transparent'
    : ((pBorderColor?.value || '').trim() || undefined);

  const bw = parseInt(pBorderWidth?.value, 10);
  f.borderWidth = Number.isFinite(bw) ? clamp(bw, 1, 8) : undefined;

  f.bgTransparent = !!pBgTransparent?.checked;
  f.bgColor = f.bgTransparent
    ? 'transparent'
    : ((pBgColor?.value || '').trim() || undefined);

  const fs = parseInt(pFontSize?.value, 10);
  const autoFs = Number.isFinite(f.inputHeight) ? (f.inputHeight - 4) : 14;
  f.fontSize = clamp(Number.isFinite(fs) ? fs : autoFs, 5, 32);

  f.textAlign = (pTextAlign?.value || '');
  f.mask      = (pMask?.value || '');
  f.maskRe    = (pMaskRe?.value || '').trim();

  const ml = parseInt(pMaxLen?.value, 10);
  f.maxLength = Number.isFinite(ml) ? clamp(ml, 1, 500) : undefined;

  f.placeholder = (pPlaceholder?.value || '').trim();
  f.autoDate    = (pAutoDate?.value || '');
  f.locked      = !!pLocked?.checked;
  f.lockOnPh    = !!pLockOnPh?.checked;

  render();
  scheduleSave();
  recalcDevicePricing();
  refreshConditionalInvalid();
};

document.getElementById('delField').onclick = () => {
  if (selected < 0) {
    alert('삭제할 필드를 먼저 클릭해서 선택해주세요.');
    return;
  }

  const f = cur().fields[selected];
  if (f && f.id) {
    delete valuesById[f.id];
    delete elById[f.id];
  }

  cur().fields.splice(selected, 1);
  selected = -1;
  render();
  scheduleSave();
  recalcDevicePricing();
  refreshConditionalInvalid();
};

/* ===== 정렬 버튼 ===== */
function alignSelectedX(mode){
  if(selected<0) return;
  const f=cur().fields[selected];
  if(mode==='left')   f.x = 0;
  if(mode==='center') f.x = clamp(50 - (f.w??24)/2, 0, 100);
  if(mode==='right')  f.x = clamp(100 - (f.w??24), 0, 100);
  render(); scheduleSave(); recalcDevicePricing(); refreshConditionalInvalid();
}
function alignSelectedY(mode){
  if(selected<0) return;
  const f=cur().fields[selected];
  if(mode==='top')    f.y = 0;
  if(mode==='middle') f.y = 50;
  if(mode==='bottom') f.y = 100;
  render(); scheduleSave(); recalcDevicePricing(); refreshConditionalInvalid();
}
document.getElementById('alignLeft').onclick = ()=>alignSelectedX('left');
document.getElementById('alignCX').onclick   = ()=>alignSelectedX('center');
document.getElementById('alignRight').onclick= ()=>alignSelectedX('right');
document.getElementById('alignTop').onclick  = ()=>alignSelectedY('top');
document.getElementById('alignCY').onclick   = ()=>alignSelectedY('middle');
document.getElementById('alignBottom').onclick=()=>alignSelectedY('bottom');

/* ===== 페이지 ===== */
const changePage=d=>{
  pageIndex=clamp(pageIndex+d,0,pages.length-1);
  selected=-1;
  render();
  scheduleSave();
  recalcDevicePricing();
  refreshConditionalInvalid();
};
document.getElementById('prev').onclick=()=>changePage(-1);
document.getElementById('next').onclick=()=>changePage(1);

/* ===== 저장/초기화 ===== */
document.getElementById('saveJson').onclick=()=>{
  const age = getSafeAge();
  const blob=new Blob([JSON.stringify({pages},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`overlay-design.device.${age}.json`; // ✅
  a.click();
  URL.revokeObjectURL(a.href);
};

document.getElementById('resetValues').onclick=()=>{
  pages.forEach(pg=>(pg.fields||[]).forEach(f=>delete f.value));
  Object.keys(valuesById).forEach(k=>delete valuesById[k]);
  selected=-1;
  clearAutosave();
  render();
  recalcDevicePricing();
  refreshConditionalInvalid();
};

/* ===== 필수 검증/토스트 ===== */
function findMissingAll(){
  const miss=[];
  const condReq = getConditionalRequiredSet();

  pages.forEach((pg,pi)=>{
    (pg.fields||[]).forEach((f,fi)=>{
      const fid = (f.id || '').toString();
      const isRequired = !!f.required || (fid && condReq.has(fid));

      if(!isRequired) return;
      if (f.locked && f.lockOnPh && !f.value) return;

      const v=(f.type==='checkbox')?!!f.value:(f.value??'').toString().trim();
      if(!v) miss.push({page:pi,idx:fi,label:(f.label||f.id||`필드${fi+1}`), id: fid});
    });
  });
  return miss;
}

function markInvalidForPage(pIdx,list){
  if(pIdx!==pageIndex) return;
  overlay.querySelectorAll('.field.invalid').forEach(el=>el.classList.remove('invalid'));
  list.forEach(m=>{
    const el=overlay.querySelector(`.field[data-i="${m.idx}"]`);
    if(el) el.classList.add('invalid');
  });
}
function showToast(items){
  const toast=document.getElementById('toast'), list=document.getElementById('missList');
  list.innerHTML=items.map(m=>`<li>${m}</li>`).join('');
  toast.style.display='flex';
  document.getElementById('tClose').onclick=()=>toast.style.display='none';
}

/* ===== 이미지/폰트 대기 ===== */
async function waitForImages(root){
  const imgs=Array.from(root.querySelectorAll('img'));
  if(!imgs.length) return;
  await Promise.all(imgs.map(img=>{
    if(img.complete && img.naturalWidth>0) return Promise.resolve();
    return new Promise(res=>{
      const done=()=>{ img.removeEventListener('load',done); img.removeEventListener('error',done); res(); };
      img.addEventListener('load',done,{once:true});
      img.addEventListener('error',done,{once:true});
    });
  }));
}

/* ===== 인쇄 DOM ===== */
function createPrintDOM(page){
  const wrap = document.createElement('div');
  wrap.className = 'paper';

  const st = document.createElement('div');
  st.className = 'stage';
  st.style.transform = 'scale(1)';

  const img = document.createElement('img');
  img.src = page.bg || '';

  const ov = document.createElement('div');
  ov.className = 'overlay';

  st.appendChild(img);
  st.appendChild(ov);
  wrap.appendChild(st);

  (page.fields || []).forEach(f => {
    const w = document.createElement('div');
    w.className =
      'field ' +
      (f.type === 'radio' ? 'radio ' : '') +
      (f.type === 'checkbox' ? 'checkbox ' : '');

    w.style.left = `${f.x}%`;
    w.style.top  = `${f.y}%`;
    w.style.width = `${(f.w ?? 24)}%`;

    if (f.type === 'checkbox' || f.type === 'radio') {
      const tickColor = (f.borderTransparent) ? 'transparent' : (f.borderColor || '#000');
      const tickWidth = Number.isFinite(Number(f.borderWidth))
        ? Math.max(0, Math.min(8, Number(f.borderWidth)))
        : 1.6;
      w.style.setProperty('--tick-bdc', tickColor);
      w.style.setProperty('--tick-bdw', tickWidth + 'px');
    }

    if (f.fontSize) w.style.setProperty('--fs', f.fontSize + 'px');

if (f.type === 'radio') {
  const rs = (f.radioStyle || 'dot');
  w.classList.remove('rd-dot','rd-solid','rd-tick');
  w.classList.add('rd-' + rs);

  w.style.setProperty('--rsize', (f.radioSize ?? 18) + 'px');
  w.style.setProperty('--rgap',  (f.radioGap  ?? 12) + 'px');

  if (f.radioShowText === false) w.classList.add('noText');

  // ✅✅✅ 여기 추가: 라디오 "박스(.radio-item)" 테두리 변수도 인쇄 DOM에 세팅
  const outerColor =
    (f.radioOuterBorderTransparent || f.borderTransparent)
      ? 'transparent'
      : (f.radioOuterBorderColor || 'rgba(0,0,0,.25)');

  const outerWidth = Number.isFinite(Number(f.radioOuterBorderWidth))
    ? Math.max(0, Math.min(8, Number(f.radioOuterBorderWidth)))
    : 1;

  w.style.setProperty('--rbc', outerColor);
  w.style.setProperty('--rbw', outerWidth + 'px');
}


    
    if (f.color)       w.style.setProperty('--fgc', f.color);
    if (f.inputHeight) w.style.setProperty('--ih', f.inputHeight + 'px');

    const lab = document.createElement('div');
    lab.className = 'label';
    lab.textContent = f.label || '';
    w.appendChild(lab);

    let ctrl;
    const lockByPlaceholder = !!f.lockOnPh && !!f.placeholder && !f.value;

    const treatAsTextarea =
      f.type === 'textarea' ||
      (f.type === 'text' && (f.wrap));

    if (treatAsTextarea) {
      ctrl = document.createElement('textarea');
      ctrl.spellcheck = false;
      ctrl.style.resize = 'none';
      ctrl.value = f.value ?? '';
      if (f.placeholder && lockByPlaceholder) ctrl.placeholder = f.placeholder;
      if (f.inputHeight) {
        ctrl.style.minHeight = f.inputHeight + 'px';
        ctrl.style.height    = f.inputHeight + 'px';
      } else {
        ctrl.style.minHeight = '5px';
        ctrl.style.height    = 'auto';
      }
      if (f.locked || lockByPlaceholder) ctrl.readOnly = true;
    }
    else if (f.type === 'select') {
      ctrl = document.createElement('select');
      const phText = (f.placeholder || '').trim();
      if (phText) {
        const op0 = document.createElement('option');
        op0.value = '';
        op0.textContent = phText;
        op0.disabled = true;
        op0.hidden = true;
        ctrl.appendChild(op0);
      }
      (f.options || []).forEach(o => {
        const packed = String(o ?? '');
        const { id, name } = parsePackedId(packed);

        const op = document.createElement('option');
        op.value = id || packed;
        op.textContent = name || id || packed;
        ctrl.appendChild(op);
      });
      ctrl.value = parsePackedId(f.value ?? '').id || '';

      ctrl.style.color = (f.color || '#000');
      ctrl.style.caretColor = (f.color || '#000');
      ctrl.style.backgroundColor = (f.bgTransparent ? 'transparent' : (f.bgColor || 'transparent'));
      ctrl.querySelectorAll('option').forEach(op => {
        op.style.color = '#000';
        op.style.backgroundColor = '#fff';
      });

      if (f.locked || lockByPlaceholder) ctrl.disabled = true;

      const pv = document.createElement('div');
      pv.className = 'print-value';
      const selText = (ctrl.options[ctrl.selectedIndex] || {}).text || ctrl.value || '';
      pv.textContent = selText;
      w.appendChild(pv);
    }
    else if (f.type === 'checkbox') {
      ctrl = document.createElement('input');
      ctrl.type = 'checkbox';
      ctrl.checked = !!f.value;
      if (f.locked || lockByPlaceholder) ctrl.disabled = true;
    }
    else if (f.type === 'radio') {
      ctrl = document.createElement('div');
      const opts = Array.isArray(f.options) ? f.options : [];
      opts.forEach(o => {
        const it = document.createElement('label');
        it.className = 'radio-item';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = (f.value === o);
        if (f.locked || lockByPlaceholder) cb.disabled = true;

        const hideText = (f.radioShowText === false) || /^\d+$/.test(String(o).trim());
        it.appendChild(cb);
        if (!hideText) {
          const s = document.createElement('span');
          s.textContent = o;
          it.appendChild(s);
        }
        ctrl.appendChild(it);
      });
    }
    else {
      ctrl = document.createElement('input');
      ctrl.type = 'text';
      ctrl.value = f.value ?? '';
      if (f.placeholder && lockByPlaceholder) ctrl.placeholder = f.placeholder;
      if (f.locked || lockByPlaceholder) ctrl.readOnly = true;
      if (f.inputHeight) ctrl.style.height = f.inputHeight + 'px';
    }

    if (f.color) ctrl.style.color = f.color;
    if (f.textAlign) { ctrl.style.textAlign = f.textAlign; w.style.setProperty('--ta', f.textAlign); }

    w.appendChild(ctrl);
    ov.appendChild(w);
  });

  return wrap;
}

function buildPrintAll(){
  const container = document.getElementById('printAll');
  container.innerHTML = '';

  pages.forEach((pg) => {
    const pageWrap = document.createElement('div');
    pageWrap.className = 'pageWrap';
    const printed = createPrintDOM(pg);
    pageWrap.appendChild(printed);
    container.appendChild(pageWrap);
  });

  requestAnimationFrame(()=>{ autosizeAllTextareas(container); });
  return container;
}

async function printAllNow(){
  const container=buildPrintAll();
  if(document.fonts && document.fonts.ready){ try{ await document.fonts.ready; }catch{} }
  await waitForImages(container);
  await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
  setTimeout(()=>window.print(),0);
}

/* ===== 인쇄 버튼 ===== */
document.getElementById('btnPdf').onclick=async ()=>{
  const all=findMissingAll();
  if(all.length){
     SHOW_INVALID = true;  
    const first=all[0].page; pageIndex=first; render();
    const listForPage=all.filter(m=>m.page===first);
    markInvalidForPage(first,listForPage);
    showToast(listForPage.map(m=>`p${m.page+1} - ${m.label}`));
    return;
  }
  await printAllNow();
};

/* ===== text → textarea 전환 스위치 ===== */
function enableWrapAllTextFields(){
  pages.forEach(pg => {
    (pg.fields || []).forEach(f => {
      if (f.type === 'text') {
        f.wrap = true;
        if (!f.inputHeight) f.inputHeight = 28;
      }
    });
  });
  render(); scheduleSave(); recalcDevicePricing(); refreshConditionalInvalid();
}
const wrapBtn = document.getElementById('enableWrapAll');
if (wrapBtn) wrapBtn.onclick = enableWrapAllTextFields;

/* ===== 부트 ===== */
async function boot(){
  await loadDesign();

  applyAutoDateAll();

  await loadDevicePricingSeparated();
  if (DEVICE_DB) applyDeviceDbToDesign();

  if(!FRESH) tryLoadAutosave();
  render();
  recalcDevicePricing();
  refreshConditionalInvalid();
}
document.getElementById('reload').onclick=boot;

window.addEventListener('DOMContentLoaded',()=>{ boot(); applyZoom(); });
</script>
</body>
</html>
